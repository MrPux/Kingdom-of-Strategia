<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kingdom of Strategia</title>

    <style>
        header {
            height: 50px;
            background-color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        header h1 {
            margin: 0;
            padding: 0;
            color: white;
        }

        html,
        body {
            width: 100%;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: sans-serif;
        }

        #container {
            display: flex;
            flex-direction: row;
            width: 100vw;
            height: auto;
        }

        #map-wrapper {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        #map {
            position: relative;
            width: 2000px;
            height: 2000px;
            background-color: #e8e8e8;
            background-image:
                linear-gradient(to right, #ccc 1px, transparent 1px),
                linear-gradient(to bottom, #ccc 1px, transparent 1px);
            background-size: 50px 50px;
            transition: transform 0.9s ease;
        }

        #spyglass-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: contain;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        #sidebar {
            width: auto;
            box-sizing: border-box;
            height: 100vh;
            background-color: #009a7e;
            padding: 15px;
            overflow-y: auto;
            color: white;
            z-index: 1000;
        }

        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        img {
            position: absolute;
            z-index: 2;
        }

        ul {
            padding-left: 20px;
        }

        .enemy {
        position: absolute;
        transform: translate(-50%, -50%); /* this centers the div at the x,y */
    }

    .enemy-sprite {
        display: block;
        max-width: 100%;
        height: auto;
    }


        /* Binocular overlay */
    </style>
</head>

<body>

    <header>
        <nav>
            <h1>Kingdom of Strategia</h1>
        </nav>
    </header>

    <div id="container">

        <div id="map-wrapper">
            <div id="map">

                <button id="village-action-btn" style="
                    position: absolute;
                    z-index: 10;
                    display: none;
                    padding: 5px 10px;
                    background-color: rgba(0, 102, 110, 0.517);
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                ">
                    View
                </button>

                <div id="village-tooltip" style="
                    position: absolute;
                    display: none;
                    padding: 8px 12px;
                    background-color: #444;
                    color: white;
                    font-size: 14px;
                    border-radius: 5px;
                    z-index: 9;
                    white-space: nowrap;
                    transform: translate(-50%, -100%);
">
                    <span id="tooltip-text">Village</span>
                    <div style="
                        position: absolute;
                        bottom: -8px;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 0;
                        height: 0;
                        border-left: 8px solid transparent;
                        border-right: 8px solid transparent;
                        border-top: 8px solid #444;
                    "></div>
                </div>


                <svg id="game-lines">
                    <th:block th:each="road : ${roads}">
                        <th:block th:if="${road != null and road.fromVillage != null and road.toVillage != null}">
                            <text th:attr="x=${(road.fromVillage.xCoordinate + road.toVillage.xCoordinate) / 2},
                                           y=${(road.fromVillage.yCoordinate + road.toVillage.yCoordinate) / 2 - 10}"
                                font-size="12" fill="black" th:text="'W: ' + ${road.weight}"></text>
                            <line th:attr="x1=${road.fromVillage.xCoordinate + 30},
                                           y1=${road.fromVillage.yCoordinate + 30},
                                           x2=${road.toVillage.xCoordinate + 30},
                                           y2=${road.toVillage.yCoordinate + 30}" stroke="red" stroke-width="5" />
                        </th:block>
                    </th:block>
                </svg>

                <!-- Mountains -->
                <th:block th:each="mountain : ${mountains}">
                    <img th:src="@{/assets/mountains/{file}(file=${mountain.sprite})}"
                        th:style="'left: ' + ${mountain.XCoordinate} + 'px; top: ' + ${mountain.YCoordinate} + 'px;'"
                        width="60" height="60"/>

                </th:block>

                <!-- Villages -->
                <th:block th:each="village : ${villages}">
                    <img class="village-img" th:src="@{${village.sprite}}"
                        th:style="'left: ' + ${village.XCoordinate} + 'px; top: ' + ${village.YCoordinate} + 'px;' + (${village.id == startingVillage.id} ? 'border: 5px solid green;' : '')"
                        width="60" height="50" />
                </th:block>

                <!-- Enemies -->
            <!-- Corrected enemy rendering block -->
            <th:block th:each="enemy : ${enemies}">
                <img th:src="@{/assets/enemies/{file}(file=${enemy.sprite})}"
                    th:style="'left: ' + ${enemy.xCoordinate} + 'px; top: ' + ${enemy.yCoordinate} + 'px;'"
                    width="30" height="30" />
            </th:block>



                <img id="spyglass-overlay" src="/assets/spyglass.png" alt="Spyglass View"
                    style="width: 100%; height: 100%;" />
            </div>
        </div>

        <div id="sidebar">
            <h2>Controls</h2>
            <h5>ZOOM IN - double click</h5>
            <h5>ZOOM OUT - double click</h5>
            <h2>Table Info</h2>
            <ul>
                <li th:each="road : ${roads}" th:text="'From (' + ${road.fromVillage.XCoordinate} + ', ' + ${road.fromVillage.YCoordinate} +
                                ') To (' + ${road.toVillage.XCoordinate} + ', ' + ${road.toVillage.YCoordinate} +
                                ') W: ' + ${road.weight}">
                </li>
            </ul>
        </div>
    </div>


    <script>
        window.addEventListener('load', () => {

      
            const button = document.getElementById("village-action-btn");
            const villageImgs = document.querySelectorAll(".village-img");
            const tooltip = document.getElementById("village-tooltip");
            const tooltipText = document.getElementById("tooltip-text");


            button.addEventListener("mouseenter", () => {
                button.style.backgroundColor = "rgba(0, 102, 110, 0.517)"; // original color
                button.style.color = "white";
            });

            button.addEventListener("mouseleave", () => {
                button.style.backgroundColor = "rgba(66, 66, 66, 0.517)";
                button.style.color = "white";
                button.style.display = "none";
            });

            villageImgs.forEach(img => {
                img.addEventListener("mouseenter", (e) => {
                    const rect = img.getBoundingClientRect();
                    const mapRect = map.getBoundingClientRect();

                    const left = rect.left - mapRect.left + img.offsetWidth / 2;
                    const top = rect.top - mapRect.top - 10;

                    const btnLeft = left - 25;
                    const btnTop = top + img.offsetHeight + 10; // ðŸ‘ˆ new: below the village

                    // Tooltip logic
                    const src = img.getAttribute("src");
                    const fileName = src.split("/").pop().replace(".png", "");
                    const formatted = fileName.replace(/[-_]/g, " ").replace(/\b\w/g, c => c.toUpperCase());

                    tooltipText.textContent = formatted;
                    tooltip.style.left = `${left}px`;
                    tooltip.style.top = `${top}px`;
                    tooltip.style.display = "block";

                    // Button logic
                    button.style.left = `${btnLeft}px`;
                    button.style.top = `${btnTop}px`;
                    button.style.display = "block";
                });

                img.addEventListener("mouseleave", () => {
                    setTimeout(() => {
                        if (!button.matches(":hover")) {
                            button.style.display = "none";
                        }
                    }, 200);
                    tooltip.style.display = "none";
                });
            });


            button.addEventListener("mouseleave", () => {
                button.style.display = "none";
            });

            // Optional: what happens when you click the button
            button.addEventListener("click", () => {
                alert("Visiting the village!");
            });



            const map = document.getElementById('map');
            const wrapper = document.getElementById('map-wrapper');
            const spyglass = document.getElementById('spyglass-overlay');

            let zoomedIn = false;
            const zoomFactor = 4.8;
            let zoomOrigin = { x: 0, y: 0 };

            const initialScroll = {
                left: wrapper.scrollLeft,
                top: wrapper.scrollTop
            };


            function updateSpyglassPosition(x, y) {
                const wrapperRect = wrapper.getBoundingClientRect();
                const mapRect = map.getBoundingClientRect();

                // Convert map coordinates to screen coordinates
                const screenX = x - wrapper.scrollLeft + mapRect.left;
                const screenY = y - wrapper.scrollTop + mapRect.top;

                // Your exact offsets
                spyglass.style.left = `${screenX - 60}px`;
                spyglass.style.top = `${screenY - 10}px`;

                spyglass.style.width = '65px';
                spyglass.style.height = 'auto';
                spyglass.style.transform = `scale(${zoomFactor})`;
            }



            map.addEventListener('dblclick', (e) => {
                const rect = map.getBoundingClientRect();
                const x = e.clientX - rect.left + wrapper.scrollLeft;
                const y = e.clientY - rect.top + wrapper.scrollTop;

                zoomedIn = !zoomedIn;

                document.addEventListener('mousemove', (e) => {
                    if (zoomedIn) {
                        const spyglassSize = 120; // Or match your image's width
                        const offsetX = spyglassSize / 2;
                        const offsetY = spyglassSize / 2;

                        spyglass.style.left = `${e.clientX - offsetX}px`;
                        spyglass.style.top = `${e.clientY - offsetY}px`;
                    }
                });


                if (zoomedIn) {
                    zoomOrigin = { x, y };
                    map.style.transformOrigin = `${x}px ${y}px`;
                    map.style.transform = `scale(${zoomFactor})`;

                    // Position and scale the spyglass at the zoom origin
                    spyglass.style.opacity = '1';
                    updateSpyglassPosition(x, y);


                } else {
                    map.style.transformOrigin = `${zoomOrigin.x}px ${zoomOrigin.y}px`;
                    map.style.transform = `scale(1)`;

                    setTimeout(() => {
                        wrapper.scrollTo({
                            left: initialScroll.left,
                            top: initialScroll.top,
                            behavior: 'smooth'
                        });
                        spyglass.style.opacity = '0';
                    }, 900);
                }
            });

            wrapper.addEventListener('scroll', () => {
                if (zoomedIn) {
                    const rect = map.getBoundingClientRect();
                    const x = zoomOrigin.x + wrapper.scrollLeft - rect.left;
                    const y = zoomOrigin.y + wrapper.scrollTop - rect.top;
                    updateSpyglassPosition(x, y);
                }
            });

            document.addEventListener('gesturestart', function (e) {
                e.preventDefault();
            });

            document.addEventListener('wheel', function (e) {
                if (e.ctrlKey) {
                    e.preventDefault();
                }
            }, { passive: false });
        });
    </script>
</body>

</html>
